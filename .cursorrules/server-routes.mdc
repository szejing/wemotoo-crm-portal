---
description: Nitro server API route handlers (proxy to backend)
globs: server/routes/**/*.ts
alwaysApply: false
---

# Server Routes (Nitro API)

## File Naming and Location

- Place under `server/routes/merchant/{resource}/`.
- Name by method and shape:
  - `many.get.ts` – list
  - `[param].get.ts` – single by param (e.g. `[code].get.ts`, `[order_no].get.ts`)
  - `create.post.ts` – create
  - `[param].patch.ts` – update
  - `[param].delete.ts` – delete
  - `restore/[param].patch.ts` – restore
- Nested resources: `[param]/nested.post.ts` (e.g. `[order_no]/items.patch.ts`).

## Structure

### Standard Handler
```typescript
import { generateHeaders } from '#root/server/base_api';
import { Routes } from '#root/server/routes.server';

export default defineEventHandler(async (event) => {
	try {
		const config = useRuntimeConfig(event);
		const query = getQuery(event);   // for GET
		// const body = await readBody(event);  // for POST/PATCH
		// const params = getRouterParams(event);

		const result = await $fetch(`${Routes.Products.Many()}`, {
			baseURL: config.public.baseUrl,
			method: 'GET',
			headers: generateHeaders(event, true),
			query,
		});
		return result;
	} catch (err) {
		return err;
	}
});
```

### When to Use generateHeaders
- `generateHeaders(event, includeAccessToken?, merchant_id?)` – from `#root/server/base_api`.
- Use `includeAccessToken: false` only for login (and pass `merchant_id` from body if needed).
- Use `generateImageHeaders(event)` for upload/image endpoints that must not send `Content-Type: application/json`.

### URL and baseURL
- Use `Routes` from `#root/server/routes.server` for path (e.g. `Routes.Products.Many()`, `Routes.Products.Single(code)`).
- Use `config.public.baseUrl` as `baseURL` so all merchant API calls go to the same backend.

## Conventions

### Params and Body
- Read path params with `getRouterParams(event)`.
- Read query with `getQuery(event)`.
- Read body with `readBody(event)` (only in POST/PATCH/PUT).
- Validate required params (e.g. `code`, `order_no`) and throw `createError({ statusCode: 400, statusMessage: '...' })` when missing.

### Errors
- Use `createError({ statusCode, statusMessage })` for HTTP errors.
- In catch, either return a shaped error response or rethrow so Nitro can send a proper status; avoid returning the raw backend error object when it might leak internals.

### No Business Logic
- Server routes are thin proxies: add headers, forward method/url/query/body to backend, return backend response.
- Do not put validation schemas, DB access, or business rules here; keep that in the backend or in client-side schema/utils.

## Anti-Patterns

- ❌ Business logic or validation in the handler
- ❌ Direct DB or external services (other than the backend API)
- ❌ Hardcoded URLs – use `Routes` and `config.public.baseUrl`
- ❌ Skipping `generateHeaders` for authenticated routes
- ❌ Returning raw `err` without a consistent error shape
